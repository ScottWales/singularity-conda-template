stages:
    - docker
    - singularity

docker:
    stage: docker
    tags: [docker]
    image:
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    script:
        - mkdir -p /kaniko/.docker
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"},\"$CI_DEPENDENCY_PROXY_SERVER\":{\"auth\":\"$(printf "%s:%s" ${CI_DEPENDENCY_PROXY_USER} "${CI_DEPENDENCY_PROXY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
        - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Dockerfile" --no-push --tarPath="${CI_PROJECT_DIR}/image.tar" --destination=image
    artifacts:
        paths: 
            - image.tar

singularity:
    stage: singularity
    tags: [docker]
    image:
        name: quay.io/singularity/singularity
        entrypoint: [""]
    script:
        singularity build image.sif image.tar
    artifacts:
        paths:
            - image.sif
