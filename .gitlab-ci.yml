stages:
    - docker
    - singularity

variables:
    OUTPUT: "/scratch/gitlab-runner/${CI_COMMIT_REF_SLUG}"

docker:
    stage: docker
    tags: [docker]
    image:
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    script:
        - mkdir -p /kaniko/.docker
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"},\"$CI_DEPENDENCY_PROXY_SERVER\":{\"auth\":\"$(printf "%s:%s" ${CI_DEPENDENCY_PROXY_USER} "${CI_DEPENDENCY_PROXY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
        - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Dockerfile" --no-push --tarPath="${OUTPUT}/image.tar" --destination=image

singularity:
    stage: singularity
    tags: [docker]
    image:
        name: quay.io/singularity/singularity
        entrypoint: [""]
    script:
        singularity build ${OUTPUT}/image.sif ${OUTPUT}/image.tar
